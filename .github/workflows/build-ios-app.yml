name: ðŸš€ Build iOS App with Tweaks

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: 'Ø±Ø§Ø¨Ø· Ù…Ù„Ù IPA Ù…ÙÙƒÙƒ Ø§Ù„ØªØ´ÙÙŠØ±'
        required: true
        type: string
      app_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚'
        required: true
        default: 'whatsapp'
        type: choice
        options:
        - whatsapp
        - youtube
        - instagram
        - tiktok
        - telegram
        - spotify
        - custom
      selected_tweaks:
        description: 'Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ù…Ø«Ù„: watusi,stalky,regram)'
        required: false
        default: 'all'
        type: string
      bundle_id:
        description: 'Bundle ID Ø¬Ø¯ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        type: string
      display_name:
        description: 'Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        type: string

jobs:
  build-modified-app:
    runs-on: macos-latest
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ› ï¸ Setup Environment
      run: |
        echo "ðŸš€ Ø¨Ø¯Ø¡ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©..."
        
        # ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        brew install ldid curl unzip zip
        
        # ØªØ«Ø¨ÙŠØª Azule
        echo "ðŸ“¦ ØªØ«Ø¨ÙŠØª Azule..."
        curl -L https://github.com/Al4ise/Azule/releases/latest/download/azule -o /usr/local/bin/azule
        chmod +x /usr/local/bin/azule
        
        # Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù€ PATH
        echo "/usr/local/bin" >> $GITHUB_PATH
        export PATH="/usr/local/bin:$PATH"
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ«Ø¨ÙŠØª
        which ldid && echo "âœ… ldid Ø¬Ø§Ù‡Ø²"
        which azule && echo "âœ… azule Ø¬Ø§Ù‡Ø²"
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø¹Ù…Ù„
        mkdir -p build output
        
    - name: ðŸ“± Download IPA
      run: |
        echo "â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù IPA Ø§Ù„Ø£ØµÙ„ÙŠ..."
        
        IPA_URL="${{ github.event.inputs.ipa_url }}"
        echo "ðŸ“ Ø§Ù„Ø±Ø§Ø¨Ø·: $IPA_URL"
        
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
        curl -L -H "User-Agent: Mozilla/5.0" -o build/original.ipa "$IPA_URL"
        
        # ÙØ­Øµ Ø§Ù„Ù…Ù„Ù
        if [ ! -f build/original.ipa ]; then
          echo "âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù"
          exit 1
        fi
        
        FILE_SIZE=$(stat -f%z build/original.ipa)
        FILE_SIZE_MB=$((FILE_SIZE/1024/1024))
        echo "âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ (${FILE_SIZE_MB}MB)"
        
    - name: ðŸ§© Prepare Tweaks
      run: |
        echo "ðŸ” Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ù„ØªØ·Ø¨ÙŠÙ‚: ${{ github.event.inputs.app_type }}"
        
        APP_TYPE="${{ github.event.inputs.app_type }}"
        mkdir -p build/tweaks
        
        # Ù†Ø³Ø® Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        case $APP_TYPE in
          whatsapp)
            echo "ï¿½ï¿½ Ø¥Ø¶Ø§ÙØ© ØªØ¹Ø¯ÙŠÙ„Ø§Øª WhatsApp..."
            if [ -d "tweaks/social/whatsapp" ]; then
              find tweaks/social/whatsapp -name "*.dylib" -exec cp {} build/tweaks/ \;
            fi
            ;;
          youtube)
            echo "ðŸ“º Ø¥Ø¶Ø§ÙØ© ØªØ¹Ø¯ÙŠÙ„Ø§Øª YouTube..."
            if [ -d "tweaks/media/youtube" ]; then
              find tweaks/media/youtube -name "*.dylib" -exec cp {} build/tweaks/ \;
            fi
            ;;
          instagram)
            echo "ðŸ“¸ Ø¥Ø¶Ø§ÙØ© ØªØ¹Ø¯ÙŠÙ„Ø§Øª Instagram..."
            if [ -d "tweaks/social/instagram" ]; then
              find tweaks/social/instagram -name "*.dylib" -exec cp {} build/tweaks/ \;
            fi
            ;;
          *)
            echo "ðŸŒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©..."
            ;;
        esac
        
        # Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
        echo "ðŸ“‹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¬Ù‡Ø²Ø©:"
        if ls build/tweaks/*.dylib 1> /dev/null 2>&1; then
          ls -lh build/tweaks/
        else
          echo "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª .dylib"
        fi
        
    - name: ðŸ”§ Inject Tweaks
      run: |
        echo "ðŸ”¨ Ø­Ù‚Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚..."
        cd build/
        
        # ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
        if [ ! "$(ls -A tweaks/)" ]; then
          echo "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„Ø§Øª - Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„"
          cp original.ipa ../output/modified.ipa
          exit 0
        fi
        
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¯Ø§Ø© Azule
        if command -v azule &> /dev/null; then
          echo "âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Azule"
          
          # Ø¨Ù†Ø§Ø¡ Ø£Ù…Ø± Ø§Ù„Ø­Ù‚Ù†
          CMD="azule -i original.ipa -o modified.ipa"
          
          # Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶
          if [ -n "${{ github.event.inputs.display_name }}" ]; then
            CMD="$CMD -n '${{ github.event.inputs.display_name }}'"
          fi
          
          # Ø¥Ø¶Ø§ÙØ© Bundle ID
          if [ -n "${{ github.event.inputs.bundle_id }}" ]; then
            CMD="$CMD -b '${{ github.event.inputs.bundle_id }}'"
          fi
          
          # Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
          for dylib in tweaks/*.dylib; do
            if [ -f "$dylib" ]; then
              CMD="$CMD -f '$dylib'"
            fi
          done
          
          # ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ù‚Ù†
          echo "ðŸƒâ€â™‚ï¸ ØªÙ†ÙÙŠØ°: $CMD"
          if eval "$CMD"; then
            echo "âœ… ØªÙ… Ø§Ù„Ø­Ù‚Ù† Ø¨Ù†Ø¬Ø§Ø­!"
          else
            echo "âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­Ù‚Ù† - Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø£Ø³Ø§Ø³ÙŠØ©"
            cp original.ipa modified.ipa
          fi
        else
          echo "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Azule - Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„"
          cp original.ipa modified.ipa
        fi
        
        # Ù†Ù‚Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        if [ -f modified.ipa ]; then
          cp modified.ipa ../output/
        else
          cp original.ipa ../output/modified.ipa
        fi
        
    - name: ðŸ” Sign App
      run: |
        echo "ðŸ–Šï¸ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚..."
        cd output/
        
        # ÙÙƒ Ø¶ØºØ· Ø§Ù„Ù€ IPA
        unzip -q modified.ipa
        
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø­Ø²Ù…Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        APP_PATH=$(find Payload -name "*.app" | head -n1)
        
        if [ -n "$APP_PATH" ]; then
          echo "ðŸ“± ØªÙˆÙ‚ÙŠØ¹: $APP_PATH"
          
          # Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ldid
          if command -v ldid &> /dev/null; then
            ldid -S "$APP_PATH"
            echo "âœ… ØªÙ… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹"
          else
            echo "âš ï¸ ldid ØºÙŠØ± Ù…ØªØ§Ø­"
          fi
          
          # Ø¥Ø¹Ø§Ø¯Ø© Ø¶ØºØ· Ø§Ù„Ù€ IPA
          rm modified.ipa
          zip -rq modified.ipa Payload/
          rm -rf Payload/
        fi
        
        echo "âœ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¬Ø§Ù‡Ø²!"
        ls -lh modified.ipa
        
    - name: ðŸ“Š Build Info
      run: |
        BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S UTC')
        IPA_SIZE=$(stat -f%z output/modified.ipa || echo "0")
        IPA_SIZE_MB=$((IPA_SIZE/1024/1024))
        
        cat > output/BUILD_INFO.txt << 'EOFTEXT'
ðŸš€ IPAenject - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
==========================================

ðŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ù†Ø§Ø¡: BUILD_DATE_PLACEHOLDER
ðŸ“± Ù†ÙˆØ¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: APP_TYPE_PLACEHOLDER
ðŸ§© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª: TWEAKS_PLACEHOLDER
ðŸ†” Bundle ID: BUNDLE_PLACEHOLDER
ðŸ“ Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶: NAME_PLACEHOLDER
ðŸ“¦ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: SIZE_PLACEHOLDER MB

âš ï¸ Ù…Ù‡Ù…:
â€¢ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø´Ø®ØµÙŠ ÙÙ‚Ø·
â€¢ ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù„ÙƒÙŠØªÙƒ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£ØµÙ„ÙŠ
â€¢ Ø§Ø³ØªØ®Ø¯Ù… AltStore Ø£Ùˆ Sideloadly Ù„Ù„ØªØ«Ø¨ÙŠØª

ðŸ“± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª:
1. Ø­Ù…Ù„ Ù…Ù„Ù modified.ipa
2. Ø«Ø¨Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø¯Ø§Ø© sideloading
3. ÙˆØ«Ù‚ Ø¨Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª

Ø¨ÙˆØ§Ø³Ø·Ø© IPAenject â¤ï¸
EOFTEXT
        
        # Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        sed -i '' "s/BUILD_DATE_PLACEHOLDER/$BUILD_DATE/g" output/BUILD_INFO.txt
        sed -i '' "s/APP_TYPE_PLACEHOLDER/${{ github.event.inputs.app_type }}/g" output/BUILD_INFO.txt
        sed -i '' "s/TWEAKS_PLACEHOLDER/${{ github.event.inputs.selected_tweaks }}/g" output/BUILD_INFO.txt
        sed -i '' "s/BUNDLE_PLACEHOLDER/${{ github.event.inputs.bundle_id }}/g" output/BUILD_INFO.txt
        sed -i '' "s/NAME_PLACEHOLDER/${{ github.event.inputs.display_name }}/g" output/BUILD_INFO.txt
        sed -i '' "s/SIZE_PLACEHOLDER/$IPA_SIZE_MB/g" output/BUILD_INFO.txt
        
    - name: ðŸ“¤ Upload Result
      uses: actions/upload-artifact@v4
      with:
        name: modified-${{ github.event.inputs.app_type }}-app
        path: |
          output/modified.ipa
          output/BUILD_INFO.txt
        retention-days: 7
        
    - name: ðŸŽ‰ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ github.run_number }}
        name: "ðŸ“± ${{ github.event.inputs.app_type }}++ - Build ${{ github.run_number }}"
        body: |
          ## ðŸš€ ØªØ·Ø¨ÙŠÙ‚ Ù…Ø­Ø³Ù† Ø¬Ø¯ÙŠØ¯
          
          **ðŸ“± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:** ${{ github.event.inputs.app_type }}
          **ðŸ§© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª:** ${{ github.event.inputs.selected_tweaks }}
          **ðŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:** $(date '+%Y-%m-%d %H:%M UTC')
          
          ### ðŸ“¥ Ø§Ù„ØªØ«Ø¨ÙŠØª:
          1. Ø­Ù…Ù„ `modified.ipa` Ø£Ø¯Ù†Ø§Ù‡
          2. Ø§Ø³ØªØ®Ø¯Ù… [AltStore](https://altstore.io) Ø£Ùˆ [Sideloadly](https://sideloadly.io)
          3. ÙˆØ«Ù‚ Ø¨Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
          
          ### âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:
          - Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø´Ø®ØµÙŠ ÙÙ‚Ø·
          - Ù…Ø¯Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: 7 Ø£ÙŠØ§Ù… (Ù…Ø¬Ø§Ù†ÙŠ) / 365 ÙŠÙˆÙ… (Ù…Ø·ÙˆØ±)
          
          ---
          **Ø¨ÙˆØ§Ø³Ø·Ø© IPAenject**
        files: |
          output/modified.ipa
          output/BUILD_INFO.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡
      run: |
        echo ""
        echo "ðŸŽ‰ ØªÙ… Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­! ðŸŽ‰"
        echo "================================="
        echo "ðŸ“± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: ${{ github.event.inputs.app_type }}"
        echo "ðŸ“¦ Ø§Ù„Ù…Ù„Ù: modified.ipa"
        echo "ðŸ”— Ø§Ù„ØªØ­Ù…ÙŠÙ„: https://github.com/${{ github.repository }}/releases/latest"
        echo "================================="
        echo "ðŸš€ ØªØ·Ø¨ÙŠÙ‚Ùƒ Ø§Ù„Ù…Ø­Ø³Ù† Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…!"
