name: ğŸš€ Build Modified iOS App

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: 'ğŸ“± Ø±Ø§Ø¨Ø· Ù…Ù„Ù IPA Ø§Ù„Ø£ØµÙ„ÙŠ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ÙÙƒÙƒ Ø§Ù„ØªØ´ÙÙŠØ±)'
        required: true
        type: string
      
      app_type:
        description: 'ğŸ“‹ Ù†ÙˆØ¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚'
        required: true
        default: 'whatsapp'
        type: choice
        options:
          - youtube
          - instagram  
          - tiktok
          - whatsapp
          - telegram
          - spotify
          - snapchat
          - discord
          - custom
      
      selected_tweaks:
        description: 'ğŸ§© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„)'
        required: false
        default: 'all'
        type: string
      
      bundle_id:
        description: 'ğŸ†” Bundle ID Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        default: ''
        type: string
      
      display_name:
        description: 'ï¿½ï¿½ Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        default: ''
        type: string
      
      app_version:
        description: 'ğŸ”¢ Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        default: '1.0.0'
        type: string

jobs:
  build:
    name: ğŸ”¨ Build Modified App
    runs-on: macos-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ› ï¸ Setup Build Environment
        run: |
          echo "ğŸš€ Setting up build environment..."
          
          # Update Homebrew and install basic tools
          brew update || true
          brew install --quiet ldid unzip zip curl wget
          
          # Install Azule with improved method
          echo "ğŸ“¦ Installing Azule..."
          
          # Download and install Azule directly
          curl -L https://github.com/Al4ise/Azule/releases/latest/download/azule -o /usr/local/bin/azule
          chmod +x /usr/local/bin/azule
          
          # Add to PATH
          echo "/usr/local/bin" >> $GITHUB_PATH
          export PATH="/usr/local/bin:$PATH"
          
          # Verify installation
          echo "ğŸ” Verifying tools..."
          which ldid && echo "âœ… ldid ready"
          which azule && echo "âœ… azule ready" || echo "âš ï¸ azule not found"
          
          # Create workspace
          mkdir -p build output
          echo "âœ… Build environment ready!"
      
      - name: ğŸ“± Download Original IPA
        run: |
          echo "â¬‡ï¸ Downloading original IPA..."
          
          IPA_URL="${{ github.event.inputs.ipa_url }}"
          echo "ğŸ“ URL: $IPA_URL"
          
          # Download with user agent to avoid blocks
          curl -L -H "User-Agent: Mozilla/5.0" -o build/original.ipa "$IPA_URL"
          
          # Check if download successful
          if [ ! -f build/original.ipa ]; then
            echo "âŒ Download failed"
            exit 1
          fi
          
          # Check file size
          FILE_SIZE=$(stat -f%z build/original.ipa 2>/dev/null || echo "0")
          FILE_SIZE_MB=$((FILE_SIZE/1024/1024))
          
          if [ $FILE_SIZE -lt 5242880 ]; then  # Less than 5MB
            echo "âš ï¸ Warning: File seems small (${FILE_SIZE_MB}MB) - might be an error page"
            head -c 500 build/original.ipa | strings | head -5 || true
          fi
          
          echo "âœ… IPA downloaded (${FILE_SIZE_MB}MB)"
      
      - name: ğŸ§© Prepare Tweaks
        run: |
          echo "ğŸ” Preparing tweaks for ${{ github.event.inputs.app_type }}..."
          
          APP_TYPE="${{ github.event.inputs.app_type }}"
          SELECTED_TWEAKS="${{ github.event.inputs.selected_tweaks }}"
          
          mkdir -p build/tweaks
          
          # Function to safely copy tweaks
          copy_app_tweaks() {
            local app_path=$1
            if [ -d "$app_path" ]; then
              echo "ğŸ“‚ Copying from $app_path"
              find "$app_path" -name "*.dylib" -exec cp {} build/tweaks/ \; 2>/dev/null || true
              find "$app_path" -name "*.framework" -type d -exec cp -r {} build/tweaks/ \; 2>/dev/null || true
            fi
          }
          
          # Copy universal tweaks
          echo "ğŸŒ Adding universal tweaks..."
          copy_app_tweaks "tweaks/universal/adblock"
          copy_app_tweaks "tweaks/universal/jailbreak-detection"
          
          # Copy app-specific tweaks
          case $APP_TYPE in
            youtube)
              echo "ğŸ“º Adding YouTube tweaks..."
              copy_app_tweaks "tweaks/media/youtube"
              ;;
            instagram)
              echo "ğŸ“¸ Adding Instagram tweaks..."
              copy_app_tweaks "tweaks/social/instagram"
              ;;
            tiktok)
              echo "ğŸµ Adding TikTok tweaks..."
              copy_app_tweaks "tweaks/media/tiktok"
              ;;
            whatsapp)
              echo "ğŸ’¬ Adding WhatsApp tweaks..."
              copy_app_tweaks "tweaks/social/whatsapp"
              ;;
            telegram)
              echo "âœˆï¸ Adding Telegram tweaks..."
              copy_app_tweaks "tweaks/social/telegram"
              ;;
            spotify)
              echo "ğŸ¶ Adding Spotify tweaks..."
              copy_app_tweaks "tweaks/media/spotify"
              ;;
            snapchat)
              echo "ğŸ‘» Adding Snapchat tweaks..."
              copy_app_tweaks "tweaks/social/snapchat"
              ;;
            discord)
              echo "ğŸ® Adding Discord tweaks..."
              copy_app_tweaks "tweaks/social/discord"
              ;;
          esac
          
          # Handle custom selection
          if [ "$SELECTED_TWEAKS" != "all" ] && [ -n "$SELECTED_TWEAKS" ]; then
            echo "ğŸ¯ Custom selection: $SELECTED_TWEAKS"
            rm -f build/tweaks/*.dylib
            
            IFS=',' read -ra TWEAKS <<< "$SELECTED_TWEAKS"
            for tweak in "${TWEAKS[@]}"; do
              tweak=$(echo "$tweak" | xargs)
              echo "  â• Adding: $tweak"
              find tweaks/ -name "*$tweak*" -name "*.dylib" -exec cp {} build/tweaks/ \; 2>/dev/null || true
            done
          fi
          
          # Show what we have
          echo "ğŸ“‹ Final tweak list:"
          if ls build/tweaks/*.dylib 1> /dev/null 2>&1; then
            ls -lh build/tweaks/
            TWEAK_COUNT=$(ls build/tweaks/*.dylib 2>/dev/null | wc -l)
            echo "ğŸ”¢ Total tweaks: $TWEAK_COUNT"
          else
            echo "  âš ï¸ No .dylib files found"
          fi
      
      - name: ğŸ”§ Apply Patches
        run: |
          echo "ğŸ”¨ Applying patches..."
          cd build/
          
          # Check for tweaks
          if [ ! "$(ls -A tweaks/ 2>/dev/null)" ]; then
            echo "âš ï¸ No tweaks found - creating unmodified copy"
            cp original.ipa ../output/modified.ipa
            exit 0
          fi
          
          echo "ğŸ’‰ Injecting tweaks..."
          
          # Try different azule locations
          AZULE=""
          for path in azule /usr/local/bin/azule ./azule; do
            if command -v "$path" &> /dev/null; then
              AZULE="$path"
              break
            fi
          done
          
          if [ -z "$AZULE" ]; then
            echo "âŒ Azule not found, creating basic copy"
            cp original.ipa ../output/modified.ipa
            exit 0
          fi
          
          echo "âœ… Using azule at: $AZULE"
          
          # Build injection command
          CMD="$AZULE -i original.ipa -o modified.ipa"
          
          # Add display name if provided
          if [ -n "${{ github.event.inputs.display_name }}" ]; then
            CMD="$CMD -n '${{ github.event.inputs.display_name }}'"
          fi
          
          # Add bundle ID if provided
          if [ -n "${{ github.event.inputs.bundle_id }}" ]; then
            CMD="$CMD -b '${{ github.event.inputs.bundle_id }}'"
          fi
          
          # Add version if provided
          if [ -n "${{ github.event.inputs.app_version }}" ]; then
            CMD="$CMD -v '${{ github.event.inputs.app_version }}'"
          fi
          
          # Add all dylib files
          for dylib in tweaks/*.dylib; do
            if [ -f "$dylib" ]; then
              CMD="$CMD -f '$dylib'"
            fi
          done
          
          # Execute injection
          echo "ğŸƒâ€â™‚ï¸ Executing: $CMD"
          if eval "$CMD"; then
            echo "âœ… Injection successful!"
          else
            echo "âŒ Injection failed, trying basic approach..."
            if eval "$AZULE -i original.ipa -o modified.ipa"; then
              echo "âœ… Basic injection worked"
            else
              echo "âŒ All methods failed, copying original"
              cp original.ipa modified.ipa
            fi
          fi
          
          # Move result
          if [ -f modified.ipa ]; then
            cp modified.ipa ../output/
            echo "âœ… Modified IPA ready!"
          else
            echo "âŒ No output, using original"
            cp original.ipa ../output/modified.ipa
          fi
      
      - name: ğŸ” Sign Application
        run: |
          echo "ğŸ–Šï¸ Signing application..."
          cd output/
          
          # Extract IPA
          unzip -q modified.ipa || { echo "âŒ Failed to extract"; exit 1; }
          
          # Find app bundle
          APP_PATH=$(find Payload -name "*.app" | head -n1)
          [ -z "$APP_PATH" ] && { echo "âŒ No app found"; exit 1; }
          
          echo "ğŸ“± Signing: $APP_PATH"
          
          # Sign with ldid
          if command -v ldid &> /dev/null; then
            ldid -S "$APP_PATH" && echo "âœ… Signed" || echo "âš ï¸ Sign failed"
          else
            echo "âš ï¸ ldid not available"
          fi
          
          # Repack
          rm modified.ipa
          zip -rq modified.ipa Payload/
          rm -rf Payload/
          
          echo "âœ… Final IPA ready!"
          ls -lh modified.ipa
      
      - name: ğŸ“Š Generate Build Info
        run: |
          echo "ğŸ“‹ Creating build information..."
          
          BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S UTC')
          IPA_SIZE=$(stat -f%z output/modified.ipa 2>/dev/null || echo "0")
          IPA_SIZE_MB=$((IPA_SIZE/1024/1024))
          
          cat > output/BUILD_INFO.txt << EOF
ğŸš€ IPAenject - Build Information
==========================================

ğŸ“… Build Date: $BUILD_DATE
ğŸ“± App Type: ${{ github.event.inputs.app_type }}
ğŸ§© Tweaks: ${{ github.event.inputs.selected_tweaks }}
ğŸ†” Bundle ID: ${{ github.event.inputs.bundle_id }}
ğŸ“ Display Name: ${{ github.event.inputs.display_name }}
ğŸ”¢ Version: ${{ github.event.inputs.app_version }}
ğŸ“¦ Size: ${IPA_SIZE_MB}MB
ğŸ—ï¸ Build: #${{ github.run_number }}

ğŸ”— Workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

âš ï¸ IMPORTANT:
â€¢ Personal use only
â€¢ Ensure you own the original app
â€¢ Use AltStore/Sideloadly to install
â€¢ Trust certificate in iOS Settings

ğŸ“± Installation:
1. Download modified.ipa
2. Install with sideloading tool
3. Trust developer certificate

ğŸ†˜ Support:
â€¢ Issues: https://github.com/${{ github.repository }}/issues
â€¢ Discussions: https://github.com/${{ github.repository }}/discussions

Built with â¤ï¸ using IPAenject
EOF
          
          echo "âœ… Build info created"
      
      - name: ğŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: modified-${{ github.event.inputs.app_type }}-build-${{ github.run_number }}
          path: |
            output/modified.ipa
            output/BUILD_INFO.txt
          retention-days: 30
      
      - name: ğŸ‰ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: "ğŸ“± ${{ github.event.inputs.app_type }}++ - Build #${{ github.run_number }}"
          body: |
            ## ğŸš€ Modified iOS App Build
            
            **ğŸ“± App:** ${{ github.event.inputs.app_type }}  
            **ğŸ§© Tweaks:** ${{ github.event.inputs.selected_tweaks }}  
            **ğŸ“… Built:** $(date '+%Y-%m-%d %H:%M UTC')
            
            ### ğŸ“¥ Installation:
            1. Download `modified.ipa` below
            2. Use [AltStore](https://altstore.io) or [Sideloadly](https://sideloadly.io)
            3. Trust certificate in Settings
            
            ### âš ï¸ Notes:
            - Personal use only
            - 7-day signing (free) / 365-day (paid developer)
            - Backup your data first
            
            ### ğŸ†˜ Help:
            Check [Issues](https://github.com/${{ github.repository }}/issues) or [Discussions](https://github.com/${{ github.repository }}/discussions)
            
            ---
            **Built with IPAenject**
          files: |
            output/modified.ipa
            output/BUILD_INFO.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: âœ… Success
        run: |
          echo ""
          echo "ğŸ‰ BUILD COMPLETED SUCCESSFULLY! ğŸ‰"
          echo "======================================"
          echo "ğŸ“± App: ${{ github.event.inputs.app_type }}"
          echo "ğŸ“¦ Output: modified.ipa"
          echo "ğŸ”— Download: https://github.com/${{ github.repository }}/releases/latest"
          echo "======================================"
          echo "ğŸš€ Your modded app is ready!"
