name: ğŸš€ Build Modified iOS App

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: 'ğŸ“± Ø±Ø§Ø¨Ø· Ù…Ù„Ù IPA Ø§Ù„Ø£ØµÙ„ÙŠ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ÙÙƒÙƒ Ø§Ù„ØªØ´ÙÙŠØ±)'
        required: true
        type: string
      
      app_type:
        description: 'ğŸ“‹ Ù†ÙˆØ¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚'
        required: true
        default: 'youtube'
        type: choice
        options:
          - youtube
          - instagram  
          - tiktok
          - whatsapp
          - telegram
          - spotify
          - snapchat
          - discord
          - custom
      
      selected_tweaks:
        description: 'ğŸ§© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„)'
        required: false
        default: 'all'
        type: string
      
      bundle_id:
        description: 'ğŸ†” Bundle ID Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        default: ''
        type: string
      
      display_name:
        description: 'ğŸ“ Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        default: ''
        type: string
      
      app_version:
        description: 'ğŸ”¢ Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        default: '1.0.0'
        type: string

jobs:
  build:
    name: ğŸ”¨ Build Modified App
    runs-on: macos-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ› ï¸ Setup Build Environment
        run: |
          echo "ğŸš€ Setting up build environment..."
          
          # Install required tools
          brew install --quiet ldid
          brew install --quiet ios-deploy
          
          # Install Azule (iOS app patcher)
          echo "ğŸ“¦ Installing Azule..."
          curl -sSL https://raw.githubusercontent.com/Al4ise/Azule/main/azule.sh | bash
          
          # Setup workspace
          mkdir -p build
          mkdir -p output
          
          echo "âœ… Build environment ready!"
      
      - name: ğŸ“± Download Original IPA
        run: |
          echo "â¬‡ï¸ Downloading original IPA..."
          
          IPA_URL="${{ github.event.inputs.ipa_url }}"
          echo "ğŸ“ URL: $IPA_URL"
          
          # Download IPA file
          curl -L -o build/original.ipa "$IPA_URL"
          
          # Verify download
          if [ ! -f build/original.ipa ]; then
            echo "âŒ Failed to download IPA file"
            exit 1
          fi
          
          # Check file size (should be > 10MB for most apps)
          FILE_SIZE=$(stat -f%z build/original.ipa)
          if [ $FILE_SIZE -lt 10485760 ]; then
            echo "âš ï¸ Warning: IPA file seems too small ($FILE_SIZE bytes)"
          fi
          
          echo "âœ… IPA downloaded successfully ($(($FILE_SIZE/1024/1024))MB)"
      
      - name: ğŸ§© Prepare Tweaks
        run: |
          echo "ğŸ” Preparing tweaks for ${{ github.event.inputs.app_type }}..."
          
          APP_TYPE="${{ github.event.inputs.app_type }}"
          SELECTED_TWEAKS="${{ github.event.inputs.selected_tweaks }}"
          
          # Create tweaks directory for this build
          mkdir -p build/tweaks
          
          # Function to copy tweaks
          copy_tweaks() {
            local category=$1
            local app=$2
            
            if [ -d "tweaks/$category/$app" ]; then
              echo "ğŸ“‚ Copying tweaks from tweaks/$category/$app/"
              cp tweaks/$category/$app/*.dylib build/tweaks/ 2>/dev/null || true
              cp tweaks/$category/$app/*.deb build/tweaks/ 2>/dev/null || true
            fi
          }
          
          # Copy universal tweaks (always included)
          echo "ğŸŒ Adding universal tweaks..."
          copy_tweaks "universal" "adblock"
          copy_tweaks "universal" "jailbreak-detection"
          copy_tweaks "universal" "flex-patches"
          
          # Copy app-specific tweaks
          case $APP_TYPE in
            youtube)
              echo "ğŸ“º Adding YouTube tweaks..."
              copy_tweaks "media" "youtube"
              ;;
            instagram)
              echo "ğŸ“¸ Adding Instagram tweaks..."
              copy_tweaks "social" "instagram"
              ;;
            tiktok)
              echo "ğŸµ Adding TikTok tweaks..."
              copy_tweaks "media" "tiktok"
              ;;
            whatsapp)
              echo "ğŸ’¬ Adding WhatsApp tweaks..."
              copy_tweaks "social" "whatsapp"
              ;;
            telegram)
              echo "âœˆï¸ Adding Telegram tweaks..."
              copy_tweaks "social" "telegram"
              ;;
            spotify)
              echo "ğŸ¶ Adding Spotify tweaks..."
              copy_tweaks "media" "spotify"
              ;;
            snapchat)
              echo "ğŸ‘» Adding Snapchat tweaks..."
              copy_tweaks "social" "snapchat"
              ;;
            discord)
              echo "ğŸ® Adding Discord tweaks..."
              copy_tweaks "social" "discord"
              ;;
            custom)
              echo "ğŸ”§ Custom app - adding universal tweaks only"
              ;;
          esac
          
          # Handle custom tweak selection
          if [ "$SELECTED_TWEAKS" != "all" ] && [ -n "$SELECTED_TWEAKS" ]; then
            echo "ğŸ¯ Processing custom tweak selection..."
            # Remove all tweaks and add only selected ones
            rm -f build/tweaks/*
            
            IFS=',' read -ra TWEAKS <<< "$SELECTED_TWEAKS"
            for tweak in "${TWEAKS[@]}"; do
              tweak=$(echo "$tweak" | xargs) # trim whitespace
              echo "  â• Adding: $tweak"
              
              # Find and copy the specified tweak
              find tweaks/ -name "$tweak*.dylib" -exec cp {} build/tweaks/ \;
              find tweaks/ -name "$tweak*.deb" -exec cp {} build/tweaks/ \;
            done
          fi
          
          # List prepared tweaks
          echo "ğŸ“‹ Tweaks prepared for injection:"
          ls -la build/tweaks/ || echo "  âš ï¸ No tweaks found"
          
          # Count tweaks
          TWEAK_COUNT=$(ls build/tweaks/*.{dylib,deb} 2>/dev/null | wc -l)
          echo "ğŸ”¢ Total tweaks: $TWEAK_COUNT"
      
      - name: ğŸ”§ Apply Patches
        run: |
          echo "ğŸ”¨ Applying patches to the app..."
          
          cd build/
          
          # Check if we have any tweaks to inject
          if [ ! "$(ls -A tweaks/)" ]; then
            echo "âš ï¸ No tweaks to inject, creating app without modifications..."
            cp original.ipa ../output/modified.ipa
            exit 0
          fi
          
          # Use Azule to inject tweaks
          echo "ğŸ’‰ Injecting tweaks using Azule..."
          
          # Prepare Azule command
          AZULE_CMD="azule -i original.ipa -o modified.ipa -n '${{ github.event.inputs.display_name || 'Modified App' }}'"
          
          # Add bundle ID if specified
          if [ -n "${{ github.event.inputs.bundle_id }}" ]; then
            AZULE_CMD="$AZULE_CMD -b '${{ github.event.inputs.bundle_id }}'"
          fi
          
          # Add version if specified
          if [ -n "${{ github.event.inputs.app_version }}" ]; then
            AZULE_CMD="$AZULE_CMD -v '${{ github.event.inputs.app_version }}'"
          fi
          
          # Add all tweaks
          for tweak in tweaks/*.{dylib,deb}; do
            if [ -f "$tweak" ]; then
              AZULE_CMD="$AZULE_CMD -f '$tweak'"
            fi
          done
          
          echo "ğŸƒâ€â™‚ï¸ Running: $AZULE_CMD"
          eval $AZULE_CMD
          
          # Verify output
          if [ -f modified.ipa ]; then
            echo "âœ… App patching completed successfully!"
            cp modified.ipa ../output/
          else
            echo "âŒ Patching failed!"
            exit 1
          fi
      
      - name: ğŸ” Sign Application
        run: |
          echo "ğŸ–Šï¸ Signing the modified application..."
          
          cd output/
          
          # Extract app for signing
          unzip -q modified.ipa
          
          # Find the app bundle
          APP_PATH=$(find Payload -name "*.app" | head -n1)
          
          if [ -z "$APP_PATH" ]; then
            echo "âŒ Could not find app bundle in IPA"
            exit 1
          fi
          
          echo "ğŸ“± App bundle: $APP_PATH"
          
          # Sign with ldid (free signing)
          echo "ğŸ”‘ Applying free signature..."
          ldid -S "$APP_PATH"
          
          # Re-package IPA
          echo "ğŸ“¦ Re-packaging IPA..."
          zip -r signed.ipa Payload/
          
          # Clean up
          rm -rf Payload/
          rm modified.ipa
          mv signed.ipa modified.ipa
          
          echo "âœ… Application signed successfully!"
      
      - name: ğŸ“Š Generate Build Info
        run: |
          echo "ğŸ“‹ Generating build information..."
          
          APP_TYPE="${{ github.event.inputs.app_type }}"
          BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S UTC')
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          cat > output/BUILD_INFO.txt << EOF
          ğŸš€ IPAenject - Build Info
          ==========================================
          
          ğŸ“… Build Date: $BUILD_DATE
          ğŸ“± App Type: $APP_TYPE
          ğŸ§© Selected Tweaks: ${{ github.event.inputs.selected_tweaks }}
          ğŸ†” Bundle ID: ${{ github.event.inputs.bundle_id || 'Default' }}
          ğŸ“ Display Name: ${{ github.event.inputs.display_name || 'Default' }}
          ğŸ”¢ Version: ${{ github.event.inputs.app_version }}
          
          ğŸ”— Workflow URL: $WORKFLOW_URL
          ğŸ“‚ Repository: ${{ github.repository }}
          ğŸ·ï¸ Commit: ${{ github.sha }}
          
          âš ï¸ IMPORTANT NOTES:
          â€¢ This is for personal use only
          â€¢ Make sure you own the original app
          â€¢ Install using AltStore, Sideloadly, or similar tools
          
          ğŸ“± Installation:
          1. Download the IPA file
          2. Use your preferred sideloading tool
          3. Trust the developer certificate in Settings
          
          ğŸ†˜ Support: Check repository issues and discussions
          EOF
          
          echo "âœ… Build info generated"
      
      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: modified-ios-app-${{ github.event.inputs.app_type }}-${{ github.run_number }}
          path: |
            output/modified.ipa
            output/BUILD_INFO.txt
          retention-days: 30
      
      - name: ğŸ‰ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: "ğŸ“± ${{ github.event.inputs.app_type }} Modified App - Build #${{ github.run_number }}"
          body: |
            ## ğŸš€ Modified iOS App Build
            
            **ğŸ“± App Type:** ${{ github.event.inputs.app_type }}  
            **ğŸ§© Tweaks:** ${{ github.event.inputs.selected_tweaks }}  
            **ğŸ”¢ Version:** ${{ github.event.inputs.app_version }}  
            **ğŸ“… Build Date:** $(date '+%Y-%m-%d %H:%M UTC')
            
            ### ğŸ“¥ Installation Instructions:
            1. Download the `modified.ipa` file below
            2. Use AltStore, Sideloadly, or your preferred sideloading tool
            3. Install the IPA on your iOS device
            4. Trust the developer certificate in Settings > General > VPN & Device Management
            
            ### âš ï¸ Important Notes:
            - This build is for **personal use only**
            - Make sure you **own the original app**
            - The signature will expire in 7 days (free account) or 1 year (developer account)
            
            ### ğŸ› Issues?
            If you encounter problems, please check our [Issues](https://github.com/${{ github.repository }}/issues) page.
            
            ---
            **Built with â¤ï¸ using IPAenject**
          files: |
            output/modified.ipa
            output/BUILD_INFO.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: âœ… Build Complete
        run: |
          echo "ğŸ‰ BUILD COMPLETED SUCCESSFULLY! ğŸ‰"
          echo ""
          echo "ğŸ“Š Build Summary:"
          echo "  ğŸ“± App Type: ${{ github.event.inputs.app_type }}"
          echo "  ğŸ§© Tweaks: ${{ github.event.inputs.selected_tweaks }}"
          echo "  ğŸ“¦ Output: modified.ipa"
          echo "  ğŸ“… Date: $(date)"
          echo ""
          echo "ğŸ”— Your modified app is now available in the Releases section!"
          echo "   Go to: https://github.com/${{ github.repository }}/releases"
          echo ""
          echo "ğŸ“± Happy sideloading! ğŸš€"
